name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
  WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
  MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_BASE64 }}
  MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
  MACOS_CERT_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY }}
  MACOS_NOTARY_APPLE_ID: ${{ secrets.MACOS_NOTARY_APPLE_ID }}
  MACOS_NOTARY_PASSWORD: ${{ secrets.MACOS_NOTARY_PASSWORD }}
  MACOS_NOTARY_TEAM_ID: ${{ secrets.MACOS_NOTARY_TEAM_ID }}

jobs:
  build-release:
    name: Build ${{ matrix.asset_os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            asset_os: linux
            arch: x86_64
            ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            asset_os: macos
            arch: aarch64
            ext: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            asset_os: macos
            arch: x86_64
            ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset_os: windows
            arch: x86_64
            ext: zip
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - name: Build enkai
        run: cargo build -p enkai --release --target ${{ matrix.target }}
      - name: Build enkai_native
        run: cargo build -p enkai_native --release --target ${{ matrix.target }}
      - name: Sign binary (Windows)
        if: runner.os == 'Windows' && env.WINDOWS_PFX_BASE64 != ''
        shell: pwsh
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          $pfxPath = "$env:RUNNER_TEMP\\enkai_sign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $bin = "target\\${{ matrix.target }}\\release\\enkai.exe"
          & "C:\\Program Files (x86)\\Windows Kits\\10\\bin\\x64\\signtool.exe" sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $bin
      - name: Sign binary (macOS)
        if: runner.os == 'macOS' && env.MACOS_CERT_BASE64 != ''
        shell: bash
        env:
          MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_BASE64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          MACOS_CERT_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY }}
        run: |
          CERT_PATH="$RUNNER_TEMP/enkai_sign.p12"
          KEYCHAIN="$RUNNER_TEMP/enkai.keychain"
          echo "$MACOS_CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "" "$KEYCHAIN"
          security import "$CERT_PATH" -k "$KEYCHAIN" -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychain -d user -s "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          BIN="target/${{ matrix.target }}/release/enkai"
          codesign --force --options runtime --sign "$MACOS_CERT_IDENTITY" "$BIN"
      - name: Notarize binary (macOS)
        if: runner.os == 'macOS' && env.MACOS_NOTARY_APPLE_ID != ''
        shell: bash
        env:
          MACOS_NOTARY_APPLE_ID: ${{ secrets.MACOS_NOTARY_APPLE_ID }}
          MACOS_NOTARY_PASSWORD: ${{ secrets.MACOS_NOTARY_PASSWORD }}
          MACOS_NOTARY_TEAM_ID: ${{ secrets.MACOS_NOTARY_TEAM_ID }}
        run: |
          BIN="target/${{ matrix.target }}/release/enkai"
          ZIP="$RUNNER_TEMP/enkai-notary.zip"
          ditto -c -k --sequesterRsrc --keepParent "$BIN" "$ZIP"
          xcrun notarytool submit "$ZIP" --apple-id "$MACOS_NOTARY_APPLE_ID" --password "$MACOS_NOTARY_PASSWORD" --team-id "$MACOS_NOTARY_TEAM_ID" --wait
          xcrun stapler staple "$BIN"
      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          BIN="target/${{ matrix.target }}/release/enkai"
          LEGACY_BIN="target/${{ matrix.target }}/release/enkai"
          if [ "$RUNNER_OS" = "macOS" ]; then
            NATIVE_ALT="target/${{ matrix.target }}/release/libenkai_native.dylib"
          else
            NATIVE_ALT="target/${{ matrix.target }}/release/libenkai_native.so"
          fi
          OUT="dist/enkai-${VERSION}-${{ matrix.asset_os }}-${{ matrix.arch }}.tar.gz"
          STAGE="dist/stage"
          rm -rf "$STAGE"
          mkdir -p "$STAGE/examples"
          chmod +x "$BIN"
          cp "$BIN" "$STAGE/enkai"
          if [ -f "$LEGACY_BIN" ]; then
            cp "$LEGACY_BIN" "$STAGE/enkai"
          fi
          cp -R std "$STAGE/std"
          cp -R examples/hello "$STAGE/examples/hello"
          cp install/README.txt "$STAGE/README.txt"
          if [ -f "$NATIVE_ALT" ]; then
            cp "$NATIVE_ALT" "$STAGE/"
          fi
          mkdir -p dist
          tar -czf "$OUT" -C "$STAGE" .
          (cd dist && shasum -a 256 "$(basename "$OUT")" > "$(basename "$OUT").sha256")
      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $bin = "target\\${{ matrix.target }}\\release\\enkai.exe"
          $legacy = "target\\${{ matrix.target }}\\release\\enkai.exe"
          $native = "target\\${{ matrix.target }}\\release\\enkai_native.dll"
          $nativeAlt = "target\\${{ matrix.target }}\\release\\enkai_native.dll"
          $out = "dist\\enkai-$version-${{ matrix.asset_os }}-${{ matrix.arch }}.zip"
          $stage = "dist\\stage"
          if (Test-Path $stage) { Remove-Item -Recurse -Force $stage }
          New-Item -ItemType Directory -Force -Path $stage | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $stage "examples") | Out-Null
          Copy-Item -Path $bin -Destination (Join-Path $stage "enkai.exe") -Force
          if (Test-Path $legacy) { Copy-Item -Path $legacy -Destination (Join-Path $stage "enkai.exe") -Force }
          if (Test-Path $nativeAlt) { Copy-Item -Path $nativeAlt -Destination $stage -Force }
          if (Test-Path $native) { Copy-Item -Path $native -Destination $stage -Force }
          Copy-Item -Recurse -Path "std" -Destination (Join-Path $stage "std") -Force
          Copy-Item -Recurse -Path "examples\\hello" -Destination (Join-Path $stage "examples\\hello") -Force
          Copy-Item -Path "install\\README.txt" -Destination (Join-Path $stage "README.txt") -Force
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Compress-Archive -Path (Join-Path $stage "*") -DestinationPath $out -Force
          $hash = (Get-FileHash -Algorithm SHA256 $out).Hash.ToLower()
          "$hash  $(Split-Path -Leaf $out)" | Out-File -Encoding ascii "$out.sha256"
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*

  windows-installer:
    name: Windows installer (Inno Setup)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build enkai
        run: cargo build -p enkai --release
      - name: Build installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: installer/enkai.iss
          options: /DMyAppVersion=${{ github.ref_name }}
      - name: Sign installer (Inno)
        if: env.WINDOWS_PFX_BASE64 != ''
        shell: pwsh
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          $pfxPath = "$env:RUNNER_TEMP\\enkai_sign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $exe = "dist\\enkai-setup-$version.exe"
          & "C:\\Program Files (x86)\\Windows Kits\\10\\bin\\x64\\signtool.exe" sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $exe
      - name: Checksum
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $exe = "dist\\enkai-setup-$version.exe"
          $hash = (Get-FileHash -Algorithm SHA256 $exe).Hash.ToLower()
          "$hash  $(Split-Path -Leaf $exe)" | Out-File -Encoding ascii "$exe.sha256"
      - name: Upload installer
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*

  windows-installer-wix:
    name: Windows installer (WiX)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install WiX Toolset
        run: choco install wixtoolset -y
      - name: Build enkai
        run: cargo build -p enkai --release
      - name: Build MSI
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          candle.exe -dProductVersion=$version -out dist\\enkai.wixobj installer\\enkai.wxs
          light.exe -out dist\\enkai-setup-wix-$version.msi dist\\enkai.wixobj -ext WixUIExtension
      - name: Sign MSI
        if: env.WINDOWS_PFX_BASE64 != ''
        shell: pwsh
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        run: |
          $pfxPath = "$env:RUNNER_TEMP\\enkai_sign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $msi = "dist\\enkai-setup-wix-$version.msi"
          & "C:\\Program Files (x86)\\Windows Kits\\10\\bin\\x64\\signtool.exe" sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $msi
      - name: Checksum
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart('v')
          $hash = (Get-FileHash -Algorithm SHA256 "dist\\enkai-setup-wix-$version.msi").Hash.ToLower()
          "$hash  enkai-setup-wix-$version.msi" | Out-File -Encoding ascii "dist\\enkai-setup-wix-$version.msi.sha256"
      - name: Upload MSI
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
