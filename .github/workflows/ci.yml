name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Format
        run: cargo fmt --check --all
      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings
      - name: Test
        run: cargo test --workspace
  package-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build release binaries
        run: |
          cargo build -p morph --release
          cargo build -p morph_native --release
      - name: Package and verify
        run: |
          VERSION="0.0.0"
          BIN="target/release/morph"
          NATIVE="target/release/libmorph_native.so"
          OUT="dist/morph-${VERSION}-linux-x86_64.tar.gz"
          STAGE="dist/stage"
          rm -rf "$STAGE"
          mkdir -p "$STAGE/examples"
          cp "$BIN" "$STAGE/morph"
          chmod +x "$STAGE/morph"
          cp -R std "$STAGE/std"
          cp -R examples/hello "$STAGE/examples/hello"
          cp install/README.txt "$STAGE/README.txt"
          if [ -f "$NATIVE" ]; then
            cp "$NATIVE" "$STAGE/"
          fi
          mkdir -p dist
          tar -czf "$OUT" -C "$STAGE" .
          tar -tzf "$OUT" | grep -q "^morph$"
          tar -tzf "$OUT" | grep -q "^README.txt$"
          tar -tzf "$OUT" | grep -q "^std/"
          tar -tzf "$OUT" | grep -q "^examples/hello/main.morph$"
          tar -tzf "$OUT" | grep -q "^libmorph_native.so$"
          EXTRACT="dist/extract"
          rm -rf "$EXTRACT"
          mkdir -p "$EXTRACT"
          tar -xzf "$OUT" -C "$EXTRACT"
          (cd "$EXTRACT" && ./morph --version)
          (cd "$EXTRACT" && ./morph run examples/hello/main.morph)
  torch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install PyTorch CPU
        run: |
          python -m pip install --upgrade pip
          python -m pip install torch==2.2.0+cpu --index-url https://download.pytorch.org/whl/cpu
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Test morph_tensor with torch
        env:
          LIBTORCH_USE_PYTORCH: "1"
          PYTHON_SYS_EXECUTABLE: python
        run: |
          TORCH_LIB_DIR=$(python -c "import os, torch; print(os.path.join(os.path.dirname(torch.__file__), 'lib'))")
          export LD_LIBRARY_PATH="$TORCH_LIB_DIR:${LD_LIBRARY_PATH:-}"
          cargo test -p morph_tensor --features torch
